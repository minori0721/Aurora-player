<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Player (Final UI Fix)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.4.0/color-thief.min.js"></script>

    <style>
        :root {
            --bg-1: #e0c3fc; --bg-2: #8ec5fc;
            --text-main: #2c3e50; --text-sub: rgba(44, 62, 80, 0.6);
            --glass: rgba(255, 255, 255, 0.4);
            --glass-strong: rgba(255, 255, 255, 0.9);
            --border: rgba(255, 255, 255, 0.6);
            --accent: #2980b9;
        }

        body {
            margin: 0; height: 100vh;
            background-color: #f5f7fa;
            background-image: 
                radial-gradient(circle at 10% 20%, var(--bg-1) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, var(--bg-2) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, #fff 0%, transparent 60%);
            background-size: 150% 150%;
            animation: bgMove 15s infinite alternate;
            color: var(--text-main); font-family: 'Segoe UI', sans-serif;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
            transition: --bg-1 1s, --bg-2 1s;
        }
        @keyframes bgMove { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }

        #visual-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        .top-bar { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; z-index: 100; }
        .tool-group { display: flex; gap: 10px; }
        .glass-btn {
            background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; color: var(--text-main);
            display: flex; align-items: center; gap: 5px; transition: 0.2s; outline: none;
        }
        .glass-btn:hover { background: #fff; transform: translateY(-2px); }

        .loop-panel {
            position: absolute; top: 70px; right: 20px; background: var(--glass-strong); padding: 20px; border-radius: 15px;
            border: 1px solid var(--border); width: 300px; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 90; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 12px;
        }
        .loop-panel.show { transform: translateX(0); }
        .loop-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
        .loop-input { width: 80px; border: 1px solid #ccc; border-radius: 5px; padding: 4px; text-align: center; font-family: monospace; }
        
        .main-container { width: 85vw; height: 80vh; display: grid; grid-template-columns: 450px 1fr; gap: 80px; position: relative; z-index: 10; }
        .left-panel { display: flex; flex-direction: column; justify-content: center; position: relative; }
        .cover-wrapper { width: 100%; padding-bottom: 100%; position: relative; margin-bottom: 40px; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.1)); }
        .default-disc {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, #e0e0e0, #ffffff, #e0e0e0, #d0d0d0, #ffffff, #e0e0e0);
            box-shadow: inset 0 0 0 5px rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center;
            animation: spin 10s linear infinite paused;
        }
        .default-disc::after { content:''; width:20%; height:20%; background:#f5f7fa; border-radius:50%; border:5px solid rgba(255,255,255,0.5); }
        .playing .default-disc { animation-play-state: running; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .album-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 20px; opacity: 0; transition: opacity 0.5s; }
        
        .progress-section { margin-top: auto; }
        .time-display { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 12px; font-weight: 500; display: flex; justify-content: space-between;}
        .progress-bar-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; position: relative; cursor: pointer; transition: height 0.2s; overflow: visible;}
        .progress-bar-bg:hover { height: 12px; }
        .progress-line { position: absolute; top: 0; left: 0; width: 0%; height: 100%; background: var(--text-main); border-radius: 4px; }
        .buffer-line { position: absolute; top: 0; left: 0; width: 0%; height: 100%; background: rgba(255,255,255,0.6); border-radius: 4px; transition: width 0.2s; }
        
        .loop-marker { 
            position: absolute; top: -6px; width: 2px; height: 20px; background: #e74c3c; 
            z-index: 20; pointer-events: none; display: none; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }
        .loop-marker::after { content: attr(data-label); position: absolute; top: -15px; left: -50%; color: #e74c3c; font-size: 10px; font-weight: bold; }

        .right-panel { display: flex; flex-direction: column; justify-content: center; position: relative; }
        .track-header { margin-bottom: 20px; }
        .track-title { font-size: 3rem; font-weight: 800; margin: 0 0 10px 0; line-height: 1.1; }
        .track-artist { font-size: 1.2rem; color: var(--text-sub); font-weight: 500; }
        
        /* ‰øÆÂ§çÔºöÂ¢ûÂä† padding-left Èò≤Ê≠¢ÊñáÂ≠óÊ∫¢Âá∫ */
        .lyrics-box { 
            height: 350px; 
            overflow: hidden; 
            margin-bottom: 30px; 
            position: relative; 
            padding-left: 20px; /* <--- ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁªôÂÆπÂô®Âä†ÂÜÖËæπË∑ù */
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); 
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); 
        }
        .lyrics-scroll { transition: transform 0.3s ease-out; width: 100%; text-align: left; }
        
        .lyric-line { 
            font-size: 1.1rem; 
            color: var(--text-sub); 
            margin: 14px 0; 
            cursor: pointer; 
            opacity: 0.6; 
            transition: 0.2s; 
            line-height: 1.4; 
        }
        
        /* ‰øÆÂ§çÔºöÂà†Èô§‰∫Ü margin-left: -5px */
        .lyric-line.active { 
            color: var(--text-main); 
            font-size: 1.4rem; 
            font-weight: 800; 
            opacity: 1; 
            /* margin-left: -5px; <--- Â∑≤Âà†Èô§ */
            transform-origin: left center;
        }

        .controls-row { display: flex; align-items: center; justify-content: flex-start; gap: 25px; padding-top: 20px; }
        .btn { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn:hover { background: #fff; transform: translateY(-3px); }
        .btn svg { width: 20px; height: 20px; fill: currentColor; }
        .btn-play { width: 70px; height: 70px; background: var(--text-main); color: #fff; }
        .btn-play:hover { background: #000; }

        .playlist-sidebar { position: fixed; right: 0; top: 0; bottom: 0; width: 320px; background: var(--glass-strong); backdrop-filter: blur(30px); box-shadow: -10px 0 40px rgba(0,0,0,0.05); transform: translateX(100%); transition: transform 0.4s; z-index: 95; padding: 80px 30px 30px 30px; overflow-y: auto; }
        .playlist-sidebar.show { transform: translateX(0); }
        .pl-item { padding: 12px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; color: var(--text-sub); margin-bottom: 5px; display: flex; align-items: center; }
        .pl-item:hover { background: rgba(0,0,0,0.05); }
        .pl-item.active { background: #fff; color: var(--text-main); font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .drag-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        body.drag-on .drag-mask { opacity: 1; pointer-events: all; }
        .loading-tip { position: absolute; bottom: 20px; font-size: 0.8rem; color: #2980b9; display: none; font-weight: bold; }
        
        .tag-source { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.1); margin-left: 10px; vertical-align: middle;}

        /* Ë∞ÉËØïÊéßÂà∂Âè∞ÔºöÈªòËÆ§ÈöêËóèÔºåÂ•ΩÁúãÁöÑÊÇ¨ÊµÆÁ™ó */
        #debug-console {
            position: fixed; top: 70px; left: 20px; width: 350px; max-height: 200px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace; font-size: 11px;
            overflow-y: auto; z-index: 9999; padding: 10px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: all;
            display: none; /* ÈªòËÆ§ÈöêËóè */
            border: 1px solid rgba(255,255,255,0.2);
        }
        .log-warn { color: yellow; } .log-err { color: #ff5555; font-weight: bold; } .log-suc { color: #55ff55; font-weight: bold; }
    </style>
</head>
<body id="body">
    
    <div id="debug-console"><div>> Debugger Ready.</div></div>
    
    <canvas id="visual-canvas"></canvas>
    <div class="drag-mask"><h1>ÊäïÂñÇÈü≥‰πê</h1><p>MP3 / FLAC / OGG / SLI (Native)</p></div>

    <div class="top-bar">
        <div class="tool-group">
            <select id="effect-select" class="glass-btn">
                <option value="none">‚ú® Êó†ÁâπÊïà</option>
                <option value="snow">‚ùÑÔ∏è ÂáõÂÜ¨È£ûÈõ™</option>
                <option value="bars">üìä ÂæãÂä®È¢ëË∞±</option>
                <option value="waves">üåä ÊûÅÂÖâÊ≥¢Êµ™</option>
            </select>
            <button id="toggle-debug" class="glass-btn">üêû Debug</button>
        </div>
        <div class="tool-group">
            <button id="toggle-loop-panel" class="glass-btn">üîÅ Âæ™ÁéØËÆæÂÆö</button>
            <button id="toggle-list" class="glass-btn">üìú Êí≠ÊîæÂàóË°®</button>
        </div>
    </div>

    <div class="loop-panel" id="loop-panel">
        <h4 style="margin:0; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">Loop Controller</h4>
        <div class="loop-row"><span>ÂºÄÂêØÂæ™ÁéØ</span><input type="checkbox" id="loop-enable"></div>
        <div class="loop-row" style="background:rgba(0,0,0,0.05); padding:5px; border-radius:5px;"><span title="‰øÆÊ≠£ÈááÊ†∑Áéá">Base Rate (Hz)</span><input type="number" id="base-rate" class="loop-input" value="44100" step="100"></div>
        <div class="loop-row"><span>Start (A)</span><input type="number" id="loop-start" class="loop-input" step="0.001" value="0"></div>
        <div class="loop-row"><span>End (B)</span><input type="number" id="loop-end" class="loop-input" step="0.001" value="0"></div>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <button class="glass-btn" style="flex:1; justify-content:center;" onclick="setLoopPoint('a')">Set A</button>
            <button class="glass-btn" style="flex:1; justify-content:center;" onclick="setLoopPoint('b')">Set B</button>
        </div>
        <div id="loop-msg" style="font-size:0.7rem; color:green; height:15px; text-align:right;"></div>
    </div>

    <div class="playlist-sidebar" id="playlist-sidebar"><h3 style="margin-top:0;">PLAYLIST</h3><div id="pl-container"></div></div>

    <div class="main-container">
        <div class="left-panel">
            <div class="cover-wrapper" id="cover-wrap">
                <div class="default-disc"></div>
                <img src="" class="album-img" id="album-img" crossorigin="anonymous">
                <div class="loading-tip" id="loading-tip">Decoding Audio...</div>
            </div>
            <div class="progress-section">
                <div class="time-display">
                    <span id="curr-time">00:00</span>
                    <span id="loop-status" style="color:#e74c3c; display:none; font-weight:bold; font-size:0.8rem">‚àû SEAMLESS</span>
                    <span id="total-time">00:00</span>
                </div>
                <div class="progress-bar-bg" id="prog-bg">
                    <div class="buffer-line" id="buffer-line"></div>
                    <div class="progress-line" id="prog-line"></div>
                    <div class="loop-marker" id="marker-a" data-label="A"></div>
                    <div class="loop-marker" id="marker-b" data-label="B"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="track-header">
                <div class="track-title" id="track-title">Aurora Player</div>
                <div class="track-artist" id="track-artist">System Ready</div>
            </div>
            <div class="lyrics-box" id="lyrics-box">
                <div class="lyrics-scroll" id="lyrics-content"><div class="lyric-line active" style="margin-top: 100px;">Ready.</div></div>
            </div>
            <div class="controls-row">
                <button class="btn" id="mode-btn"><svg id="icon-list-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg><svg id="icon-random" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg><svg id="icon-single" style="display:none" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg></button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
                <button class="btn btn-play" id="play-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Êó•ÂøóÁ≥ªÁªü ---
        const debugConsole = document.getElementById('debug-console');
        function log(msg, type='') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `log-item ${type==='error'?'log-err':(type==='success'?'log-suc':'')}`;
            div.textContent = `> ${msg}`;
            debugConsole.appendChild(div);
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        // --- 1. ÂÖ®Â±ÄÂàùÂßãÂåñ ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let actx = new AudioContext();
        let audioBuffer = null, sourceNode = null, gainNode = actx.createGain(), analyser = actx.createAnalyser();
        gainNode.connect(analyser); analyser.connect(actx.destination); analyser.fftSize = 512;

        let playbackState = { startTime: 0, pauseTime: 0, isPlaying: false, duration: 0 };
        let playlist = [], curIdx = -1, playMode = 0;
        let lyrics = [], isSyncedLyrics = true;
        let loopState = { active: false, start: 0, end: 0 };
        let particles = [];

        // UI ÂºïÁî®
        const el = {
            img: document.getElementById('album-img'), coverWrap: document.getElementById('cover-wrap'),
            title: document.getElementById('track-title'), artist: document.getElementById('track-artist'),
            lyricBox: document.getElementById('lyrics-content'),
            progBg: document.getElementById('prog-bg'), progLine: document.getElementById('prog-line'), bufferLine: document.getElementById('buffer-line'),
            currTime: document.getElementById('curr-time'), totalTime: document.getElementById('total-time'),
            plContainer: document.getElementById('pl-container'), playBtn: document.getElementById('play-btn'),
            effectSel: document.getElementById('effect-select'), canvas: document.getElementById('visual-canvas'),
            loopPanel: document.getElementById('loop-panel'), loopStart: document.getElementById('loop-start'), loopEnd: document.getElementById('loop-end'), loopEnable: document.getElementById('loop-enable'),
            baseRateInput: document.getElementById('base-rate'), loopMsg: document.getElementById('loop-msg'),
            markerA: document.getElementById('marker-a'), markerB: document.getElementById('marker-b'),
            modeBtn: document.getElementById('mode-btn'), loadTip: document.getElementById('loading-tip')
        };
        const colorThief = new ColorThief();
        const canvasCtx = el.canvas.getContext('2d');

        // --- 2. ÂéüÁîü FLAC Ëß£ÊûêÂô® ---
        async function parseFlacTagsNative(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const view = new DataView(e.target.result);
                    let offset = 0;
                    if (view.getUint32(0) !== 0x664C6143) { resolve(null); return; }
                    offset += 4;
                    log("FLAC Header Found.", 'success');

                    let loopLimit = 0;
                    while(offset < view.byteLength && loopLimit < 100) {
                        loopLimit++;
                        const header = view.getUint8(offset);
                        const isLast = (header & 0x80) !== 0;
                        const type = header & 0x7F;
                        const len = view.getUint32(offset) & 0x00FFFFFF; 
                        offset += 4;

                        if (type === 4) { // VORBIS_COMMENT
                            log("Vorbis Comment Block Found.", 'success');
                            try {
                                const vendorLen = view.getUint32(offset, true);
                                offset += 4 + vendorLen;
                                const commentListLen = view.getUint32(offset, true);
                                offset += 4;
                                
                                let tags = {};
                                const decoder = new TextDecoder("utf-8");

                                for(let i=0; i<commentListLen; i++) {
                                    const commentLen = view.getUint32(offset, true);
                                    offset += 4;
                                    const commentStr = decoder.decode(new Uint8Array(e.target.result, offset, commentLen));
                                    offset += commentLen;

                                    const splitIdx = commentStr.indexOf('=');
                                    if(splitIdx > -1) {
                                        const key = commentStr.substring(0, splitIdx).toUpperCase();
                                        const val = commentStr.substring(splitIdx + 1);
                                        
                                        if(key === 'LYRICS' || key === 'UNSYNCED LYRICS') tags.lyrics = val;
                                        else if (key === 'TITLE') tags.title = val;
                                        else if (key === 'ARTIST') tags.artist = val;
                                        else if (key === 'ALBUM') tags.album = val;
                                    }
                                }
                                resolve(tags);
                                return;
                            } catch(err) { log("Parse Error: " + err, 'error'); }
                        }
                        offset += len;
                        if (isLast) break;
                    }
                    resolve(null);
                };
                reader.readAsArrayBuffer(file.slice(0, 512 * 1024));
            });
        }

        // --- 3. Êñá‰ª∂Â§ÑÁêÜ ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
        document.body.addEventListener('dragenter', () => document.body.classList.add('drag-on'));
        document.body.addEventListener('dragleave', (e) => { if(e.clientX===0 && e.clientY===0) document.body.classList.remove('drag-on'); });
        document.body.addEventListener('drop', handleDrop);

        function handleDrop(e) {
            document.body.classList.remove('drag-on');
            const files = Array.from(e.dataTransfer.files);
            const audios = files.filter(f => f.type.startsWith('audio/') || /\.(mp3|flac|wav|m4a|ogg)$/i.test(f.name));
            const lrcs = {}, slis = {};

            files.forEach(f => {
                if(f.name.endsWith('.lrc')) lrcs[f.name.replace('.lrc','')] = f;
                if(f.name.endsWith('.sli') || f.name.includes('.ogg.sli')) {
                    let base = f.name.replace('.sli','').replace('.ogg','');
                    slis[base] = f;
                }
            });

            if(audios.length) {
                playlist = audios.map(f => {
                    const base = f.name.replace(/\.[^.]+$/, "");
                    return { file: f, name: base, lrcFile: lrcs[base] || null, sliFile: slis[base] || null };
                });
                playlist.sort((a,b) => a.name.localeCompare(b.name));
                renderPlaylist();
                playTrack(0);
            } else if (Object.keys(slis).length > 0 && curIdx !== -1) {
                const cur = playlist[curIdx];
                if(slis[cur.name]) { cur.sliFile = slis[cur.name]; parseSLI(cur); }
            }
        }

        // --- 4. Êí≠ÊîæÊµÅÁ®ã ---
        async function playTrack(i) {
            if(i < 0 || i >= playlist.length) return;
            curIdx = i; renderPlaylist();
            const track = playlist[i];
            stopAudio();

            el.title.textContent = track.name; el.artist.textContent = "Loading...";
            el.img.style.opacity = 0; el.loadTip.style.display = 'block';
            el.progLine.style.width = '0%'; el.bufferLine.style.width = '0%';
            lyrics = []; isSyncedLyrics = true;
            el.lyricBox.innerHTML = '<div class="lyric-line active" style="margin-top:100px">Parsing...</div>';
            resetLoopUI();
            log(`Track: ${track.name}`);

            try {
                const ab = await track.file.arrayBuffer();
                el.bufferLine.style.width = '30%';

                // ÂÖÉÊï∞ÊçÆËß£Êûê
                let meta = null;
                // A. FLAC ÂéüÁîü
                if(track.file.name.toLowerCase().endsWith('.flac')) {
                    log("Detect FLAC. Using Native Parser...");
                    meta = await parseFlacTagsNative(track.file);
                } 
                // B. ÂÖ∂‰ªñÊ†ºÂºè jsmediatags
                else {
                    jsmediatags.read(track.file, {
                        onSuccess: (tag) => {
                            const c = {
                                title: tag.tags.title,
                                artist: tag.tags.artist,
                                lyrics: tag.tags.lyrics || (tag.tags.USLT ? tag.tags.USLT.data : ""),
                                picture: tag.tags.picture
                            };
                            applyMetadata(c, "ID3");
                        },
                        onError: () => {
                            updateTheme(null);
                            if(!track.lrcFile) el.lyricBox.innerHTML = '<div class="lyric-line active" style="margin-top:100px">Pure Music</div>';
                        }
                    });
                }

                if(meta) applyMetadata(meta, "Native");

                // Ëß£Á†Å
                el.bufferLine.style.width = '60%';
                audioBuffer = await actx.decodeAudioData(ab);
                el.bufferLine.style.width = '100%';
                playbackState.duration = audioBuffer.duration;
                el.totalTime.textContent = fmtTime(playbackState.duration);
                el.loadTip.style.display = 'none';
                
                if(el.artist.textContent === "Loading...") el.artist.textContent = "Ready";

                if(track.sliFile) await parseSLI(track);
                startAudio(0);
                el.coverWrap.classList.add('playing');
                updatePlayIcon();

                // Â§ñÈÉ®Ê≠åËØç
                if(track.lrcFile) readLrcFile(track.lrcFile);

            } catch(e) {
                log("Err: " + e, 'error');
                alert("Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãDebugÁ™óÂè£");
            }
        }

        // Â∫îÁî®ÂÖÉÊï∞ÊçÆ
        function applyMetadata(common, source) {
            if(common.title) el.title.textContent = common.title;
            if(common.artist) el.artist.textContent = common.artist;
            
            // Â∞ÅÈù¢
            if(common.picture && typeof common.picture === 'object' && !el.img.src.startsWith('data')) {
                // jsmediatags Ê†ºÂºè
                const data = common.picture.data;
                const format = common.picture.format;
                if(data && format) {
                    let base64 = "";
                    for(let j=0; j<data.length; j++) base64 += String.fromCharCode(data[j]);
                    el.img.src = `data:${format};base64,${window.btoa(base64)}`;
                    el.img.onload = () => { el.img.style.opacity = 1; updateTheme(el.img); }
                }
            } else if (!el.img.src.startsWith('data')) {
                 updateTheme(null);
            }

            // Ê≠åËØç
            if(common.lyrics) {
                log("Lyrics found.", 'success');
                let clean = common.lyrics.replace(/\/\s*(?=\[\d{2}:)/g, '\n');
                if(!clean.includes('\n') && clean.includes('/')) clean = clean.replace(/\s*\/\s*/g, '\n');
                parseAndRenderLyrics(clean, source);
            } else if(lyrics.length === 0) {
                el.lyricBox.innerHTML = '<div class="lyric-line active" style="margin-top:100px">Pure Music</div>';
            }
        }

        // --- 3. Ê≠åËØçÊ∏≤Êüì ---
        function readLrcFile(file) {
            const r = new FileReader();
            r.onload = e => parseAndRenderLyrics(e.target.result, "LRC File");
            r.readAsText(file);
        }

        function parseAndRenderLyrics(text, source) {
            const lines = text.split(/[\r\n]/);
            const reg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lyrics = [];
            let hasTimeTag = false;

            lines.forEach(l => {
                const m = reg.exec(l);
                if(m) {
                    hasTimeTag = true;
                    lyrics.push({
                        t: parseInt(m[1])*60 + parseInt(m[2]) + parseInt(m[3])/1000, 
                        txt: l.replace(reg,'').replace(/\[.*?\]/g, '').trim() 
                    });
                } else {
                    const clean = l.trim();
                    if(clean) lyrics.push({ t: -1, txt: clean });
                }
            });

            el.lyricBox.innerHTML = `<div style="height:120px"></div>`;
            isSyncedLyrics = hasTimeTag;

            if(isSyncedLyrics) {
                lyrics.forEach(l => {
                    if(l.t === -1) return;
                    const d = document.createElement('div'); d.className = 'lyric-line'; d.textContent = l.txt; d.onclick = () => startAudio(l.t); 
                    el.lyricBox.appendChild(d); 
                });
                el.artist.innerHTML += ` <span class="tag-source">${source}</span>`;
            } else {
                el.lyricBox.innerHTML = `<div style="padding:20px; text-align:center; white-space:pre-wrap; color:var(--text-main); font-size:1rem; line-height:1.8;">${text}</div>`;
                el.artist.innerHTML += ` <span class="tag-source">Unsynced</span>`;
            }
            if(isSyncedLyrics) el.lyricBox.innerHTML += '<div style="height:150px"></div>';
        }

        // --- 4. Èü≥È¢ëÂºïÊìé (Ê†áÂáÜ) ---
        function startAudio(offset) {
            if(sourceNode) sourceNode.disconnect();
            sourceNode = actx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.connect(gainNode);

            if(loopState.active && loopState.end <= audioBuffer.duration && loopState.start < loopState.end) {
                sourceNode.loop = true; sourceNode.loopStart = loopState.start; sourceNode.loopEnd = loopState.end;
                document.getElementById('loop-status').style.display = 'inline';
            } else {
                sourceNode.loop = false;
                document.getElementById('loop-status').style.display = 'none';
            }

            sourceNode.start(0, offset);
            playbackState.startTime = actx.currentTime - offset;
            playbackState.pauseTime = offset;
            playbackState.isPlaying = true;

            sourceNode.onended = () => {
                if(!sourceNode.loop && playbackState.isPlaying && (getCurrentTime() >= playbackState.duration - 0.2)) handleNext();
            };
        }
        function stopAudio() { if(sourceNode) { try{sourceNode.stop()}catch(e){}; sourceNode.disconnect(); sourceNode=null; } playbackState.isPlaying = false; }
        function getCurrentTime() {
            if(!playbackState.isPlaying) return playbackState.pauseTime;
            let t = actx.currentTime - playbackState.startTime;
            if(loopState.active && sourceNode.loop && t > loopState.end) {
                const dur = loopState.end - loopState.start;
                t = loopState.start + (t - loopState.end) % dur;
            } else if (t > playbackState.duration) t = playbackState.duration;
            return t;
        }

        // --- 5. Ê∏≤ÊüìÂæ™ÁéØ ---
        function renderLoop() {
            requestAnimationFrame(renderLoop);
            const now = getCurrentTime();
            el.currTime.textContent = fmtTime(now);
            if(playbackState.duration) el.progLine.style.width = (now / playbackState.duration) * 100 + '%';

            if(isSyncedLyrics && lyrics.length) {
                let idx = lyrics.findIndex(l => l.t > now) - 1;
                if(idx < 0) idx = lyrics.length - 1; if(now < lyrics[0]?.t) idx = -1;
                const activeLine = el.lyricBox.children[idx + 1];
                if(activeLine && !activeLine.classList.contains('active')) {
                    document.querySelectorAll('.lyric-line').forEach(l => l.classList.remove('active'));
                    activeLine.classList.add('active');
                    const offset = activeLine.offsetTop - el.lyricBox.parentNode.offsetHeight/2 + activeLine.offsetHeight/2;
                    el.lyricBox.style.transform = `translateY(-${offset}px)`;
                }
            }
            renderVisuals();
        }
        renderLoop();

        // --- 6. ‰∫§‰∫í ---
        el.playBtn.onclick = () => {
            if(actx.state === 'suspended') actx.resume();
            if(playbackState.isPlaying) { playbackState.pauseTime = getCurrentTime(); stopAudio(); el.coverWrap.classList.remove('playing'); updatePlayIcon(); }
            else { if(audioBuffer) { startAudio(playbackState.pauseTime); el.coverWrap.classList.add('playing'); updatePlayIcon(); } }
        };
        el.progBg.onclick = e => { 
            if(!playbackState.duration) return;
            const pct = e.offsetX / el.progBg.offsetWidth;
            const target = pct * playbackState.duration;
            if(playbackState.isPlaying) startAudio(target);
            else { playbackState.pauseTime = target; el.progLine.style.width = pct*100+'%'; el.currTime.textContent = fmtTime(target); }
        };
        function handleNext() {
            if(playMode === 1) playTrack(Math.floor(Math.random()*playlist.length));
            else if(playMode === 2) startAudio(0);
            else playTrack(curIdx + 1 >= playlist.length ? 0 : curIdx + 1);
        }
        document.getElementById('prev-btn').onclick = () => playTrack(curIdx - 1 < 0 ? playlist.length-1 : curIdx - 1);
        document.getElementById('next-btn').onclick = handleNext;
        el.modeBtn.onclick = () => {
            playMode = (playMode + 1) % 3;
            ['icon-list-loop', 'icon-random', 'icon-single'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById(['icon-list-loop', 'icon-random', 'icon-single'][playMode]).style.display = 'block';
        };

        // Loop & SLI
        async function parseSLI(track) {
            return new Promise(resolve => {
                const r = new FileReader();
                r.onload = e => {
                    const m = e.target.result.match(/From\s*=\s*(\d+)\s*;\s*To\s*=\s*(\d+)/i);
                    if(m) {
                        const rate = parseInt(el.baseRateInput.value) || 44100;
                        applyLoop(parseInt(m[2])/rate, parseInt(m[1])/rate);
                        el.loopMsg.textContent = `SLI Loaded`;
                    }
                    resolve();
                };
                r.readAsText(track.sliFile);
            });
        }
        function applyLoop(s, e) {
            el.loopStart.value = s.toFixed(3); el.loopEnd.value = e.toFixed(3);
            el.loopEnable.checked = true; loopState = { active: true, start: s, end: e };
            updateLoopMarkers();
        }
        window.setLoopPoint = function(t) {
            const now = getCurrentTime();
            if(t==='a') el.loopStart.value=now.toFixed(3); else el.loopEnd.value=now.toFixed(3);
            el.loopEnable.checked = true; el.loopEnable.dispatchEvent(new Event('change'));
        };
        el.loopEnable.addEventListener('change', e => {
            if(e.target.checked) {
                const s = parseFloat(el.loopStart.value), e_val = parseFloat(el.loopEnd.value);
                if(e_val > s) { loopState = { active: true, start: s, end: e_val }; if(playbackState.isPlaying) startAudio(getCurrentTime()); }
            } else { loopState.active = false; if(playbackState.isPlaying) startAudio(getCurrentTime()); }
            updateLoopMarkers();
        });
        function resetLoopUI() { loopState.active=false; el.loopEnable.checked=false; updateLoopMarkers(); }
        function updateLoopMarkers() {
            if(!loopState.active) { el.markerA.style.display='none'; el.markerB.style.display='none'; document.getElementById('loop-status').style.display='none'; return; }
            const d = playbackState.duration || 1;
            el.markerA.style.left = (loopState.start/d)*100+'%'; el.markerB.style.left = (loopState.end/d)*100+'%';
            el.markerA.style.display='block'; el.markerB.style.display='block'; document.getElementById('loop-status').style.display='inline';
        }

        // Utils
        function updatePlayIcon() { el.playBtn.innerHTML = playbackState.isPlaying ? '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' : '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'; }
        function fmtTime(s) { const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`; }
        function renderPlaylist() {
            el.plContainer.innerHTML = '';
            playlist.forEach((t, i) => {
                const d = document.createElement('div'); d.className = `pl-item ${i === curIdx ? 'active' : ''}`;
                d.innerHTML = `<span style="width:20px; opacity:0.5">${i+1}</span> ${t.name}`;
                d.onclick = () => playTrack(i); el.plContainer.appendChild(d);
            });
        }
        function updateTheme(img) {
            let c1 = "#e0c3fc", c2 = "#8ec5fc";
            if(img) { try { const rgb = colorThief.getColor(img); c1 = `rgb(${Math.floor((rgb[0]+255)/2)},${Math.floor((rgb[1]+255)/2)},${Math.floor((rgb[2]+255)/2)})`; c2 = `rgb(${Math.floor((rgb[0]+200)/2)},${Math.floor((rgb[1]+220)/2)},${Math.floor((rgb[2]+255)/2)})`; } catch(e){} }
            document.body.style.setProperty('--bg-1', c1); document.body.style.setProperty('--bg-2', c2);
        }
        function renderVisuals() {
            const mode = el.effectSel.value, w = el.canvas.width = window.innerWidth, h = el.canvas.height = window.innerHeight;
            canvasCtx.clearRect(0,0,w,h); if(mode==='none') return;
            let data = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(data);
            if(mode==='bars') { const bw=(w/data.length)*2.5; let x=0; for(let i=0;i<data.length;i++){ const H=data[i]*1.5; canvasCtx.fillStyle=`rgba(255,255,255,0.3)`; canvasCtx.fillRect(x,h-H/2,bw,H/2); x+=bw+1; } }
            else if(mode==='snow') {
                if(particles.length<100) particles.push({x:Math.random()*w,y:0,r:Math.random()*3+1,s:Math.random()*2+1});
                const bass=data[10]; canvasCtx.fillStyle="rgba(255,255,255,0.8)";
                particles.forEach((p,i)=>{ p.y+=p.s*(1+bass/256*5)*0.5; p.x+=Math.sin(p.y*0.01); canvasCtx.beginPath(); canvasCtx.arc(p.x,p.y,p.r,0,Math.PI*2); canvasCtx.fill(); if(p.y>h) particles[i].y=-10; });
            } else if(mode==='waves') {
                canvasCtx.beginPath(); canvasCtx.moveTo(0,h/2);
                for(let i=0;i<data.length;i++){ canvasCtx.lineTo((i/data.length)*w, h/2+Math.sin(i*0.1+performance.now()/1000)*data[i]+Math.cos(i*0.05)*50); }
                canvasCtx.strokeStyle="rgba(255,255,255,0.4)"; canvasCtx.lineWidth=2; canvasCtx.stroke();
            }
        }

        document.getElementById('toggle-list').onclick = () => document.getElementById('playlist-sidebar').classList.toggle('show');
        document.getElementById('toggle-loop-panel').onclick = () => document.getElementById('loop-panel').classList.toggle('show');
        // Debug ÊåâÈíÆÈÄªËæë
        document.getElementById('toggle-debug').onclick = () => {
            const dbg = document.getElementById('debug-console');
            dbg.style.display = (dbg.style.display === 'none' || dbg.style.display === '') ? 'block' : 'none';
        };
        updateTheme(null);
    </script>
</body>
</html>
